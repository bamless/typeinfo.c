name: Build

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
          - os: macos-latest
          - os: windows-latest
          - os: windows-latest
            cc: clang
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Install LLVM (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update && sudo apt-get install -y libclang-dev
        echo "CMAKE_PREFIX_PATH=$(llvm-config-18 --prefix)" >> $GITHUB_ENV

    - name: Install LLVM (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install llvm
        echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH
        echo "CMAKE_PREFIX_PATH=$(brew --prefix llvm)" >> $GITHUB_ENV

    - name: Install LLVM (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install llvm -y
        echo "CMAKE_PREFIX_PATH=C:\Program Files\LLVM" >> $env:GITHUB_ENV

    - name: Setup MSVC dev environment (Windows Clang)
      if: matrix.cc == 'clang'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install Ninja (Windows Clang)
      if: matrix.cc == 'clang'
      run: choco install ninja -y

    - name: Configure
      if: matrix.cc != 'clang'
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DTYPEINFO_BUILD_TESTS=ON

    - name: Configure (Windows Clang)
      if: matrix.cc == 'clang'
      run: cmake -B build -G Ninja -DCMAKE_C_COMPILER=clang-cl -DCMAKE_BUILD_TYPE=Release -DTYPEINFO_BUILD_TESTS=ON

    - name: Build
      run: cmake --build build --config Release

    - name: Run tests (Unix)
      if: runner.os != 'Windows'
      run: make -C build test

    - name: Run tests (Windows Clang)
      if: matrix.cc == 'clang'
      run: cmake --build build --target test

    - name: Run print_types (Unix)
      if: runner.os != 'Windows'
      run: ./build/examples/print_types

    - name: Run print_types (Windows MSVC)
      if: runner.os == 'Windows' && matrix.cc != 'clang'
      run: build/examples/Release/print_types.exe

    - name: Run print_types (Windows Clang)
      if: matrix.cc == 'clang'
      run: build/examples/print_types.exe
